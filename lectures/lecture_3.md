# Лекция № 3

Чтобы получить доступ к файлам в Linux, используются разрешения. Эти разрешения назначаются трем объектам: файлу, группе и другому объекту (то есть всем остальным)

## Утилита chmod

Команда `ls -l` выводит много информации о правах доступа к каждому файлу:

```
$ ls -l
  -rwxr-x--x  1  user  group  1097374 January 26 2:48 test.sh
  drw-rw-r--  1  user  group  1097374 January 26 2:48 testdir
```

Самый первый символ: `-` - признак файла, `d` - признак папки.  
Далее три группы прав: владельца, группы, остальных.  
`r` - чтение, `w` - запись, `x` - исполнение.

Для файла test.sh установлены следующие права:
- Владелец может читать, изменять и выполнять файл
- Члены группы могут только читать и выполнять файл
- Остальные пользователи могут только выполнять файл
  
`chmod` можно использовать с восьмеричными числами, где 1 — это наличие прав, а 0 — отсутствие:

```
rwx = 111 = 7
rw- = 110 = 6
r-x = 101 = 5
r-- = 100 = 4
```

### Примеры

`chmod u=rx,g+w,o-x file`: 
- владельцу (`u`) назначить права на чтение и исполнение. Прав на запись нет
- группе (`g`) добавить право на запись (дополнительно к уже имеющимся правам)
- все остальным (`o`) отнять права на исполнение

`chmod a+w file`: всем (владельцу, группе и остальным) добавить права на запись

### Специальные разрешения

Помимо битов стандартных прав `r,w,x`, существуют биты `s` и `t`.

- `s` - в разделе прав пользователя это бит SUID. The process running the file will have the owner’s user ID instead of the current user’s ID. Пример использования: `chmod u+s test.sh`. Результат: `-rwsr-x--x`
- `s` - в разделе прав группы это бит SGID. The process running the file will have the file’s group ID. Пример использования: `chmod g+s test.sh`. Результат: `-rwxr-s--x`
- `t` - это бит Sticky Bit. Применяется только к директориям. Означает, что удалять файлы в директории могут только владелец директории, владелец файла или root. Может быть полезно для Общих папок . Пример использования: `chmod +t testdir`. Результат: `drw-rw-r-t`

Similar to deletion, the sticky bit prevents a user from overwriting a file they don’t own, even if they have write access. This is especially useful in shared directories.

Бит `t` заменяет собой бит `x` в группе прав для остальных пользователей в выводе `ls -l`. Такой вот косяк. 

> Finally, if our current user does not have the ability to execute a binary that has special permissions, they will be represented in their respective set with a capital ‘S’ (SUID / SGID) or capital ‘T’ (Sticky).

Чтобы однозначно определить наличие одновременно и прав на выполнение и stickybit:
`stat --format="%a" file` - выведет 3 цифры, если специальных прав нет. Если есть специальные права, то получим 4 цифры и первая из них отвечает за специальные права (комбинация соотв сумма):
- 4 - suid
- 2 - guid
- 1 - sticky bit

Например, вывод `3755` означает, что есть следующие разрешения: guid, sticky bit, rwxr-xr-x

Бит смены владельца или **SUID (Set User ID)** — это разрешение файловой системы Linux, которое позволяет запустить исполняемый файл от имени его владельца. Он нужен, потому что многие действия в Linux (например, открытие «сырого» сетевого сокета) требуют прав суперпользователя. Хорошо знакомая всем команда ping использует сетевые сокеты и поэтому должна быть запущена от root’а. Каким образом можно позволить обычному пользователю применять команду ping? Можно выдать пользователю sudo на необходимые команды. Но представьте, что на условной Linux-машине имеется 100 пользователей и насчитывается около 20 привилегированных команд. А как потом управлять разрешениями sudo на все это «богатство»? Не самое элегантное решение, не правда ли? С другой стороны, бит смены владельца значительно упрощает процесс. Бит смены владельца сообщит системе, что все 100 пользователей системы запускают команду ping от имени root. Еще пример утилита `passwd`, которая изменяет файлы /etc/passwd и /etc/shadow, доступные только root'у.

У "другого" пользователя может вообще не быть прав на исполнение, но если задан SUID, то достаточно, чтобы пользователю был виден файл, чтобы его запустить с правами владельца.

> Linux does NOT treat the SUID-bit on shell scripts the same way it does binaries. Only binaries with the SUID bit set run as the file owner.

## Другое

`find / -user linda` - вывод всех файлов, для которых linda владелец
`find / -group users`

`chown -R linda /home/account` - смена владельца для папки и всего содержимого

## Утилита chown

`chown кто что` - Изменение владельца файла. 

Обычный пользователь не может сменить владельца файла, даже у файлов которыми он владеет. Нужны права суперпользователя.

`sudo chown newuser:newgroup file` - Изменение владельца `file` на `newuser` и группы на `newgroup`.

Обычный пользователь может сменить группу файла которым он владеет только на одну из групп в которые он входит.

`chown :newgroup file` - Изменение группы на `newgroup` (если владелец входит в группу newgroup`

## Утилита chgrp

Работает как `chown :newgroup file`

## Материалы

- https://habr.com/ru/companies/jetinfosystems/articles/506750/
- https://habr.com/ru/articles/469667/

